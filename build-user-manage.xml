<?xml version="1.0"?>

<project name="andwellness-user-manange" basedir="." default="dist-all">
  <property file="build.properties"/>
  <property name="component.repository" location="${user.home}/.component-repository"/>
  <property name="version"  value="snapshot"/>
  <property name="src" location="src/edu/ucla/cens/awuser"/>
  <property name="resources" location="web"/>
  <property name="build" location="build"/>
  <property name="dist"  location="dist"/>

  <fileset id="compile-dependencies" dir="${component.repository}">
    <include name="**/log4j-1.2.15.jar"/>
    <include name="**/spring-2.5.6-SEC01.jar"/>
    <include name="**/commons-logging-1.1.1.jar"/>
    <include name="**/commons-dbcp-1.2.2.jar"/>
  	<include name="**/commons-pool-1.5.4.jar"/>
  	<include name="**/json-dot-org-2010-01-05.jar"/>
  	<include name="**/jbcrypt-0.3.jar"/>
  </fileset>

  <fileset id="run-dependencies" dir="${component.repository}">
    <include name="**/log4j-1.2.15.jar"/>
  	<include name="**/spring-2.5.6-SEC01.jar"/>
  	<include name="**/commons-logging-1.1.1.jar"/>
  	<include name="**/mysql-connector-java-5.1.10-bin.jar"/>
  	<include name="**/commons-dbcp-1.2.2.jar"/>
  	<include name="**/commons-pool-1.5.4.jar"/>
  	<include name="**/json-dot-org-2010-01-05.jar"/>
  	<include name="**/jbcrypt-0.3.jar"/>
  </fileset>

  <fileset id="file-dependencies" dir="usernames">
  	<include name="**/add-remove-user.properties" />
  	<include name="**/add-password-to-user.properties" />
  	<include name="**/username-words.txt" />
  </fileset>	

  <path id="compile-classpath">
    <fileset refid="compile-dependencies"/>
  </path>
	
  <target name="help-properties" description="Shows what properties you may want to override on the command line.">
    <echo message="-Dcomponent.repository=&lt;path&gt;  Where to search for dependencies/versioned components during build [${component.repository}]."/>
    <echo message="-Dversion=&lt;version&gt;  Version string to use for output [${version}]."/>
  </target>

  <target name="clean" description="Removes output directories (e.g. build and dist).">
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
  </target>

  <target name="javac" description="Compiles Java files.">
    <mkdir dir="${build}/classes"/>
    <javac destdir="${build}/classes" source="1.6" target="1.6"
           debug="true" deprecation="true" optimize="false" failonerror="true" encoding="UTF-8">
      <compilerarg value="-Xlint:unchecked"/>
      <src path="${src}"/>
      <classpath refid="compile-classpath"/>
    </javac>
    <copy todir="${build}/classes">
      <fileset dir="${src}">
        <exclude name="**/*.java"/>
      </fileset>
    </copy>
  </target>

  <target name="javadoc" description="Compiles Javadocs.">
    <mkdir dir="${build}/docs"/>
    <javadoc destdir="${build}/docs" private="true" link="http://java.sun.com/javase/6/docs/api/"
             encoding="UTF-8" additionalparam="-quiet">
      <fileset dir="${src}">
        <include name="**/*.java"/>
      </fileset>
       <classpath refid="compile-classpath"/>
    </javadoc>
  </target>
 
  <target name="dist" depends="javac" description="tars and zips compiled classes, required libs, and data/config files.">
  	<echo message="Warning: Bundling of dependencies will not work if jars are organized in subdirs in component repository."/>
  	<mkdir dir="${dist}"/>
  	<mkdir dir="${dist}/lib"/>
  	<mkdir dir="${dist}/classes"/>
  	<mkdir dir="${dist}/data"/>
  	<copy todir="${dist}/lib">
  	  <fileset refid="run-dependencies"/>
  	</copy>
  	<copy todir="${dist}/classes">
  	  <fileset dir="${build}/classes">
  	    <include name="**/*.class" />
  	  </fileset>	
  	</copy>
  	<copy todir="${dist}/data">
  	  <fileset refid="file-dependencies"/>	
  	</copy>
    <tar destfile="${dist}/${ant.project.name}-${version}.tar" compression="gzip">
      <tarfileset dir="${dist}">
        <include name="classes/**"/>
        <include name="lib/**"/>
      	<include name="data/**"/>
      </tarfileset>
    </tar>
  </target>

  <target name="dist-docs" depends="javadoc" description="Compiles Javadocs and creates gzipped tarball.">
    <mkdir dir="${dist}"/>
    <tar basedir="${build}/docs" destfile="${dist}/${ant.project.name}-docs-${version}.tar.gz" longfile="gnu" compression="gzip"/>
    <zip basedir="${build}/docs" destfile="${dist}/${ant.project.name}-docs-${version}.zip" encoding="UTF-8" compress="true"/>
  </target>

  <target name="dist-all" depends="dist,dist-docs" description="Creates full distribution (WAR and docs)."/>

  <target name="release" depends="dist" description="Releases the distribution by copying it to the component repository..">
    <copy file="${dist}/${ant.project.name}-${version}.war" todir="${component.repository}/."/>
  </target>

 </project>
